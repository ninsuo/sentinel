{% extends 'project/_layout.html.twig' %}

{% set breadcrumb_items = [
    { label: 'Feature: ' ~ feature.name, url: path('app_feature_show', {projectId: project.id, featureId: feature.id}) },
    { label: 'Run #' ~ run.id }
] %}

{% block project_content %}
    <div class="d-flex justify-content-between align-items-start gap-3 mb-3">
        <div>
            <div class="text-secondary small">Feature</div>
            <div class="h4 mb-1">{{ feature.name }}</div>
            <div class="text-secondary small">
                Run #{{ run.id }}
                {% if run.status %}
                    <span class="badge text-bg-light border ms-2">{{ run.status }}</span>
                {% endif %}
            </div>
        </div>

        <div class="text-end d-flex gap-2">
            <form method="post"
                  action="{{ path('app_feature_run_generate_submit', {projectId: project.id, featureId: feature.id, runId: run.id}) }}">
                <input type="hidden" name="_token" value="{{ csrf_token('generate_run_' ~ run.id) }}">

                <button class="btn {{ run.aiResponseText ? 'btn-outline-secondary' : 'btn-primary' }}"
                        title="Generate patch">
                    {{ run.aiResponseText ? 'Regenerate' : 'Generate' }}
                </button>
            </form>

            <a class="btn {{ run.patchText ? 'btn-primary' : 'btn-outline-secondary disabled' }}"
                    {% if run.patchText %}
                        href="{{ path('app_feature_run_review', {projectId: project.id, featureId: feature.id, runId: run.id}) }}"
                    {% else %}
                        href="#"
                    {% endif %}
               title="{% if run.patchText %}Review patch{% else %}Generate a patch first{% endif %}">
                Review
            </a>
        </div>
    </div>

    <div class="row g-3">
        <div class="col-12 col-lg-6">
            <div class="card shadow-sm">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <div class="fw-semibold">Feature prompt</div>
                    <a class="btn btn-sm btn-outline-secondary"
                       href="{{ path('app_feature_edit', {projectId: project.id, featureId: feature.id}) }}">
                        Edit
                    </a>
                </div>
                <div class="card-body">
                    <pre class="mb-0 small" style="white-space: pre-wrap;">{{ feature.prompt }}</pre>
                </div>
            </div>
        </div>

        <div class="col-12 col-lg-6">
            <div class="card shadow-sm">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <div class="fw-semibold">Run prompt</div>
                    <a class="btn btn-sm btn-outline-secondary"
                       href="{{ path('app_feature_run_prompt', {projectId: project.id, featureId: feature.id, runId: run.id}) }}">
                        Edit
                    </a>
                </div>

                {% if run.userPrompt != feature.prompt %}
                    <div class="card-body">
                        <pre class="mb-0 small" style="white-space: pre-wrap;">{{ run.userPrompt }}</pre>
                    </div>
                {% else %}
                    <div class="card-body text-secondary small">
                        Same as feature prompt.
                    </div>
                {% endif %}
            </div>
        </div>

        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <div class="fw-semibold">Selected files</div>
                    <a class="btn btn-sm btn-outline-secondary"
                       href="{{ path('app_feature_run_select_files', {projectId: project.id, featureId: feature.id, runId: run.id}) }}">
                        Edit
                    </a>
                </div>

                <div class="card-body">
                    {% set selected = run.selectedFilesJson ? (run.selectedFilesJson|json_decode) : [] %}

                    {% if selected is empty %}
                        <div class="text-secondary small">
                            No files selected yet.
                        </div>
                    {% else %}
                        <div class="table-responsive">
                            <table class="table table-sm align-middle mb-0">
                                <thead class="table-light">
                                <tr>
                                    <th>Path</th>
                                    <th class="text-end">Size</th>
                                    <th class="text-end">SHA (short)</th>
                                </tr>
                                </thead>
                                <tbody>
                                {% for f in selected %}
                                    <tr>
                                        <td class="text-break">{{ f.path }}</td>
                                        <td class="text-end text-secondary small">{{ f.size ?? '-' }}</td>
                                        <td class="text-end text-secondary small">{{ (f.sha256 ?? '')|slice(0, 12) }}{% if f.sha256 is defined %}â€¦{% endif %}</td>
                                    </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% endif %}
                </div>

                {% if run.aiResponseText %}
                    <div class="card-footer bg-white">
                        <div class="small text-secondary mb-2">Latest AI response</div>
                        <pre class="mb-0 small bg-body-tertiary p-2 rounded" style="white-space: pre-wrap; max-height: 220px; overflow:auto;">{{ run.aiResponseText }}</pre>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
{% endblock %}
